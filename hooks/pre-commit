#!/bin/bash
# Pre-commit hook to prevent committing secrets

RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Patterns that indicate potential secrets
PATTERNS=(
    'eyJ[A-Za-z0-9_-]*\.[A-Za-z0-9_-]*\.[A-Za-z0-9_-]*'  # JWT tokens
    '[Aa][Pp][Ii]_?[Kk][Ee][Yy]\s*[=:]\s*["\x27][A-Za-z0-9]+'  # API_KEY = "..."
    '[Ss][Ee][Cc][Rr][Ee][Tt]\s*[=:]\s*["\x27][A-Za-z0-9]+'    # SECRET = "..."
    '[Pp][Aa][Ss][Ss][Ww][Oo][Rr][Dd]\s*[=:]\s*["\x27][^\s"'\'']+["\x27]'  # PASSWORD = "..."
    'ENCRYPTION_KEY\s*[=:]\s*["\x27][A-Za-z0-9]+'  # ENCRYPTION_KEY
)

# Files/directories to always ignore
IGNORE_FILES=(
    ".env.example"
    "CLAUDE.md"
    ".git/hooks/pre-commit"
    "hooks/pre-commit"
    "hooks/"
)

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

FOUND_SECRETS=0

for file in $STAGED_FILES; do
    # Skip ignored files/directories
    skip=0
    for ignore in "${IGNORE_FILES[@]}"; do
        if [[ "$file" == "$ignore" ]] || [[ "$file" == ${ignore}* ]]; then
            skip=1
            break
        fi
    done
    [ $skip -eq 1 ] && continue

    # Skip binary files
    if file "$file" | grep -q "binary"; then
        continue
    fi

    # Check each pattern
    for pattern in "${PATTERNS[@]}"; do
        matches=$(git diff --cached "$file" | grep -E "^\+" | grep -Ev "^\+\+\+" | grep -oE "$pattern" 2>/dev/null)
        if [ -n "$matches" ]; then
            echo -e "${RED}ERROR: Potential secret found in $file${NC}"
            echo -e "${YELLOW}Pattern matched: $pattern${NC}"
            echo "Matches:"
            echo "$matches" | head -3
            echo ""
            FOUND_SECRETS=1
        fi
    done
done

if [ $FOUND_SECRETS -eq 1 ]; then
    echo -e "${RED}========================================${NC}"
    echo -e "${RED}COMMIT BLOCKED: Potential secrets detected${NC}"
    echo -e "${RED}========================================${NC}"
    echo ""
    echo "If these are not secrets, you can bypass with:"
    echo "  git commit --no-verify"
    echo ""
    echo "Or move secrets to .env file (which is gitignored)"
    exit 1
fi

exit 0
