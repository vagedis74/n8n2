# Traefik middleware for header handling with Azure AD App Proxy
http:
  middlewares:
    # Pass Azure AD App Proxy headers to n8n for SSO authentication
    # Azure AD App Proxy headers (pass through automatically):
    # - X-MS-TOKEN-AAD-ACCESS-TOKEN: Azure AD access token (user.accesstoken)
    # - X-MS-CLIENT-PRINCIPAL-NAME: User Principal Name (user.userprincipalname)
    # - X-MS-CLIENT-PRINCIPAL-ID: Azure AD Object ID (user.objectid)
    # - X-Forwarded-Email: User's email address (user.mail) - PRIMARY for auth
    # - X-Forwarded-User: User's display name (user.displayname)
    azure-headers:
      headers:
        customRequestHeaders:
          X-Forwarded-Proto: "https"
          X-Forwarded-Host: "n8nsso.inlumi.education"
          Origin: "https://n8nsso.inlumi.education"
        # SSO headers from Azure AD App Proxy are forwarded automatically
        # n8n is configured to trust X-MS-CLIENT-PRINCIPAL-NAME for authentication

    # Security headers
    security-headers:
      headers:
        frameDeny: true
        browserXssFilter: true
        contentTypeNosniff: true
        stsIncludeSubdomains: true
        stsPreload: true
        stsSeconds: 31536000
        contentSecurityPolicy: "upgrade-insecure-requests"
        customResponseHeaders:
          X-Forwarded-Proto: "https"
